{% extends 'base.html' %} 
{% load static %} 
{% block title %}Single product{% endblock title %} 
{% block main %}
	<!-- BREADCRUMB -->
	<div id="breadcrumb">
		<div class="container">
			<ul class="breadcrumb">
				<li><a href="#">Home</a></li>
				<li><a href="#">Products</a></li>
				<li><a href="#">Category</a></li>
				<li class="active">Product Name Goes Here</li>
			</ul>
		</div>
	</div>
	<!-- /BREADCRUMB -->
	{% include "components/detail.html" %}
	{% include "components/related.html" %}

	
{% endblock main %}

{% block extra_scripts %}
	<script>
		$(document).ready(function () {
			// First checked image set
			function updateMainImage() {
				let selectedColorImage = $("input[name='color-select']:checked").closest(".color").find(".variant-img img").attr("src");
				let selectedSizeImage = $("input[name='size-select']:checked").closest(".size").find(".variant-img img").attr("src");

				// Color image exists, set it, otherwise use size image
				let selectedImage = selectedColorImage || selectedSizeImage;

				if (selectedImage) {
					$("#main-product-image").attr("src", selectedImage);
				} else {
					console.log("No image found!");
				}
			}

			// First load checked image
			updateMainImage();

			// Color or Size change event
			$(document).on("change", "input[name='color-select'], input[name='size-select']", function () {
				updateMainImage();
			});

			// Render stars
			function renderStars(rate) {
				let stars = "";
				for (let i = 1; i <= 5; i++) {
					stars += `<i class="fa ${i <= rate ? 'fa-star' : 'fa-star-o'}"></i>`;
				}
				return stars;
			}

			// Handle form submission
			$("#sendReview").click(function (e) {
				e.preventDefault();
				let review_id = $("#reviewForm #review_id").val();  // Check if editing
				let product_id = $("#reviewForm #product_id").val();  // Get product ID
				let subject = $('#reviewForm #id_subject').val();
				let comment = $('#reviewForm #id_comment').val();
				let rate = $('#reviewForm input[name="rate"]:checked').val(); // Ensure selected value is captured
				let csrfmiddlewaretoken = $('#reviewForm input[name=csrfmiddlewaretoken]').val();
				// Ensure productId is not empty
				if (!review_id && !product_id) {
					alertify.error("Review ID and Product ID is missing!");
					return;
				}
				// Ensure subject, comment, and rate are not empty
				if (subject.length > 0 && comment.length > 0 && rate != null) {		
					$.ajax({
						url: '{% url "reviewsview" %}',
						method: "POST",
						headers: {
							"X-CSRFToken": csrfmiddlewaretoken  // CSRF token passing
						},
						contentType: "application/json",
						data: JSON.stringify({review_id: review_id, product_id: product_id, subject: subject, comment: comment, rate: rate}),
						dataType: "json",
						success: function (res) {
							if(res.status == 200){
								let reviewDiv = $("#review-" + res.review_id);
								if (reviewDiv.length) {
									// If editing, update existing review
									reviewDiv.find(".review-subject").text(res.subject);
									reviewDiv.find(".review-comment").text(res.comment);
									reviewDiv.find(".review-rating").html(renderStars(res.rate)); // Update stars dynamically
								} else {
									// If new review, append it
									$(".product-reviews").prepend(`
										<div class="single-review" id="review-${res.review_id}">
											<div class="review-heading">
												<div><i class="fa fa-user-o"></i> ${res.user}</div>
												<div><i class="fa fa-clock-o"></i> ${res.updated_date}</div>
												<div class="edit_review" style="float: inline-end;">
													<button type="button" class="btn btn-sm primary-btn edit-review"
														data-id="${res.review_id}" data-subject="${res.subject}"
														data-comment="${res.comment}" data-rate="${res.rate}">
														<i class="fa-regular fa-pen-to-square"></i>
													</button>
												</div>
												<div class="review-rating pull-right">
													${renderStars(res.rate)} <!-- âœ… Updated properly -->
												</div>
											</div>
											<div class="review-body">
												<p class="review-subject">${res.subject}</p>
												<p class="review-comment">${res.comment}</p>
											</div>
										</div>
									`);
								} 
								// Clear form fields
								// Optionally clear the form after submission
								$('#reviewForm')[0].reset();
								$('.reviews_total_avg').load(location.href + ' .reviews_total_avg');
								$('.review_count').load(location.href + ' .review_count');
								$('.reviews_total').load(location.href + ' .reviews_total');
								alertify.success(res.messages)
							}
							else if(res.status == 400){
								alertify.error(res.messages)
							}
							else if(res.status == 400){
								alertify.error(res.messages)
							}
						},
					});
				}
				// Ensure subject, comment, and rate are not empty
				if (subject == "") {
					alertify.error("Subject is empty!");
				}
				if (comment == "") {
					alertify.error("Comment is empty!");
				}
				if (rate == null) {
					alertify.error("Rate is empty!");
				}

			});
			
			// Handle edit review
			$(document).on("click", ".edit-review", function () {
				let review_id = $(this).data("id");
				let subject = $(this).data("subject");
				let comment = $(this).data("comment");
				let rate = $(this).data("rate"); // Get the stored rating

				$("#review_id").val(review_id);
				$("#id_subject").val(subject);
				$("#id_comment").val(comment);

				// Clear any existing selection first
				$("input[name='rate']").prop("checked", false);

				// Select the correct rating based on the review
				$(`input[name='rate'][value='${rate}']`).prop("checked", true);
			});

			// Listen for changes in the size selection
			$(document).on("change", "#size-select", function() {
				let selectedSize = $(this).val();
				if(selectedSize.length) {
					$.ajax({
						url: "{% url 'getcolorsbysize' %}",
						method: "GET",
						data: {
							'size_id': selectedSize
						},
						success: function(res){
							if(res.status == 200){
								var colorHtml = "";
								$.each(res.colors, function(index, color){
									colorHtml += `
										<div class="color" style="display: flex; flex-direction: column; align-items: center;">
											<input type="radio" name="color-select" id="color-select${color.id}" value="${color.id}">
											<label for="color-select${color.id}" style="background-color:${color.code}; width: 20px; height: 20px; border-radius: 50%; cursor: pointer;"></label>
											<div class="variant-img" style="text-align: center;">
												<img class="thumb" src="${color.image}" alt="${color.title}" width="50" style="object-fit: contain;">
											</div>
											<span>${color.title} (${color.price})</span>
										</div>
									`;
								});

								// Update the color options
								$(".selected-size").text("Selected Size: " + res.selected_size_title);
								$(".selected-price").text("Selected Price: $ " + res.selected_price);
								$(".color-variant").html(colorHtml);
								alertify.success(res.messages);
							} else if(res.status == 400){
								alertify.error(res.messages);
								$(".color-variant").html("<p style='color:red;'>No colors available for this size.</p>");
							}
						}
					});
				}
			});

			// Listen for changes in the color selection
			$(document).on("change", "input[name='color-select']", function() {
				let selectedColor = $(this).val();
				if(selectedColor.length) {
					$.ajax({
						url: "{% url 'getpricebycolor' %}",
						method: "GET",
						data: {
							'color_id': selectedColor
						},
						success: function(res){
							if(res.status == 200){
								$(".selected-color").text("Selected Color: " + res.selected_color_title);
								$(".selected-price").text("Selected Price: $ " + res.selected_price);
							} else if(res.status == 400){
								errorHtml = "<p style='color:red;'>No price available for this color.</p>";
								$(".selected-color").text("");
								$(".selected-price").text("");
								$(".color-variant").html(errorHtml);
							}
						}
					});
				}
			});

			$(document).on("change", "input[name='size-select']", function() {
				let selectedSize = $(this).val();
				if(selectedSize.length) {
					$.ajax({
						url: "{% url 'getpricebysize' %}",
						method: "GET",
						data: {
							'size_id': selectedSize
						},
						success: function(res){
							if(res.status == 200){
								$(".selected-size").text("Selected Size: " + res.selected_size_title);
								$(".selected-price").text("Selected Price: $ " + res.selected_price);
							} else if(res.status == 400){
								errorHtml = "<p style='color:red;'>No price available for this size.</p>";
								$(".selected-size").text("");
								$(".selected-price").text("");
								$(".color-variant").html(errorHtml);
							}
						}
					});
				}
			});

		});
	</script>
{% endblock extra_scripts %}	